<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribución Gamma</title>
    <style>
        /* Estilos del menú de navegación */
        .nav-container {
            background-color: #f5f5f5;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .nav-menu {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-item {
            position: relative;
        }
        
        .nav-link {
            display: block;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .nav-link:hover {
            background-color: #45a049;
        }
        
        .nav-link.active {
            background-color: #3d8b40;
        }
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 2px;
        }
        .cell {
            width: 50px;
            height: 50px;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
        }
        .results-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .chart-wrapper, .table-wrapper {
            flex: 1;
        }
        .chart {
            width: 100%;
            height: 300px;
        }
        .experiment {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .probability-table {
            max-height: 300px;
            overflow-y: auto;
        }
        .sum-row {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        .range-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .range-control input {
            width: 60px;
            padding: 5px;
        }
        .color-legend {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .probability-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .probability-control input {
            width: 80px;
        }
        .formula {
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            text-align: center;
        }
        .info {
            background-color: #e7f3fe;
            padding: 10px;
            border-left: 6px solid #2196F3;
            margin-bottom: 15px;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-container input[type="range"] {
            flex-grow: 1;
        }
        .slider-value {
            min-width: 30px;
            text-align: center;
        }
        .equation {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-family: "Courier New", monospace;
            border-left: 4px solid #4CAF50;
        }
        .mean-section {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        .stats-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .stat-box {
            flex: 1;
            background-color: #e9f7ef;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .distribution-chart {
            height: 250px;
        }
        .histogram-container {
            height: 300px;
            margin-top: 20px;
        }
        .bin-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
    <ul class="nav-menu">
    <!-- SECCIÓN VARIABLES CONTINUAS -->
    <li class="nav-section">Variables Aleatorias Continuas</li>
    <li class="nav-item"><a href="distribuionuniforme.html" class="nav-link">Uniforme</a></li>
    <li class="nav-item"><a href="distribucionGaussiana.html" class="nav-link">Gaussiana</a></li>
    <li class="nav-item"><a href="distribucionexponencial.html" class="nav-link">Exponencial</a></li>

    <!-- Separador visual (opcional) -->
    <li class="nav-divider"><hr></li>

    <!-- SECCIÓN VARIABLES DISCRETAS -->
    <li class="nav-section">Variables Aleatorias Discretas</li>
    <li class="nav-item"><a href="distrubucionBernoulii.html" class="nav-link">Bernoulli</a></li>
    <li class="nav-item"><a href="distribucionBinomial.html" class="nav-link">Binomial</a></li>
    <li class="nav-item"><a href="distribucionBinomialNegativa.html" class="nav-link active">Binomial Negativa</a></li>
    <li class="nav-item"><a href="distribucionPoisson.html" class="nav-link">Poisson</a></li>
    <li class="nav-item"><a href="distribucionGeometrica.html" class="nav-link">Geometrica</a></li>
    <li class="nav-item"><a href="distribucionHipergeometrica.html" class="nav-link">HiperGeometrica</a></li>

    <!-- Separador visual (opcional) -->
    <li class="nav-divider"><hr></li>

    <!-- OTRAS SECCIONES -->
    <li class="nav-section">Otros</li>
    <li class="nav-item"><a href="juegosAzarDaniel.html" class="nav-link">Juego pelotas</a></li>
    <li class="nav-item"><a href="distribucionGama.html" class="nav-link">Gama</a></li>
</ul>
        
        <h1>Distribución Gamma</h1>
        
        <div class="info">
            <p>La distribución Gamma es una distribución de probabilidad continua con dos parámetros: <strong>k</strong> (forma) y <strong>θ</strong> (escala).</p>
            <div class="formula">
                f(x; k, θ) = x<sup>k-1</sup> e<sup>-x/θ</sup> / (θ<sup>k</sup> Γ(k)) para x > 0
            </div>
            <p>Donde Γ(k) es la función gamma, que generaliza el factorial (Γ(n) = (n-1)! para enteros positivos).</p>
        </div>
        
        <div class="experiment">
            <h2>Simulador de Distribución Gamma</h2>
            <div class="range-control">
                <label for="shapeParam">Parámetro de forma (k):</label>
                <input type="number" id="shapeParam" min="0.1" max="10" step="0.1" value="2.0">
                
                <label for="scaleParam">Parámetro de escala (θ):</label>
                <input type="number" id="scaleParam" min="0.1" max="10" step="0.1" value="1.0">
            </div>
            
            <div class="bin-controls">
                <label for="numBins">Número de intervalos:</label>
                <input type="number" id="numBins" min="5" max="50" value="20">
                
                <label for="maxValue">Valor máximo a mostrar:</label>
                <input type="number" id="maxValue" min="1" max="50" value="10">
            </div>
        </div>
        
        <div class="mean-section">
            <h3>Media y Varianza de la Distribución Gamma</h3>
            
            <div class="equation">
                <p><strong>Fórmula de la media:</strong></p>
                <p>μ = E[X] = k × θ</p>
                <p><strong>Fórmula de la varianza:</strong></p>
                <p>σ² = Var(X) = k × θ²</p>
                <p>Donde:</p>
                <ul>
                    <li>k = parámetro de forma</li>
                    <li>θ = parámetro de escala</li>
                </ul>
            </div>
            
            <div class="stats-container">
                <div class="stat-box">
                    <p><strong>Media teórica:</strong></p>
                    <p id="theoreticalMean">2.0</p>
                </div>
                
                <div class="stat-box">
                    <p><strong>Media de la simulación:</strong></p>
                    <p id="meanValue">0</p>
                </div>
                
                <div class="stat-box">
                    <p><strong>Varianza teórica:</strong></p>
                    <p id="theoreticalVariance">2.0</p>
                </div>
                
                <div class="stat-box">
                    <p><strong>Varianza de la simulación:</strong></p>
                    <p id="varianceValue">0</p>
                </div>
            </div>
            
            <div class="distribution-chart">
                <canvas id="meanChart"></canvas>
            </div>
        </div>
        
        <div class="controls">
            <button id="simulate1">Simular 1 vez</button>
            <button id="simulate10">Simular 10 veces</button>
            <button id="simulate100">Simular 100 veces</button>
            <button id="simulate1000">Simular 1000 veces</button>
            <button id="reset">Reiniciar</button>
            
            <div class="slider-container">
                <label for="speed">Velocidad:</label>
                <input type="range" id="speed" min="1" max="10" value="5">
                <span class="slider-value" id="speedValue">5</span>
            </div>
        </div>
        
        <div>
            <h3>Resultados</h3>
            <p>Total de simulaciones: <span id="total">0</span></p>
            <p>Parámetros: k = <span id="currentK">2.0</span>, θ = <span id="currentTheta">1.0</span></p>
            
            <div class="results-container">
                <div class="chart-wrapper">
                    <div class="chart">
                        <canvas id="frequencyChart"></canvas>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <div class="probability-table">
                        <table id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Intervalo</th>
                                    <th>Frecuencia</th>
                                    <th>Frec. Relativa</th>
                                    <th>Prob. Teórica</th>
                                    <th>Diferencia</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Las filas de la tabla se generarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="histogram-container">
            <canvas id="histogramChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuración inicial
        let shapeParam = 2.0;
        let scaleParam = 1.0;
        let numBins = 20;
        let maxValue = 10;
        let results = {};
        let totalSimulations = 0;
        let simulationSpeed = 5;
        let meanHistory = [];
        let colorPalette = '#4CAF50';
        let animationId = null;
        
        // Histograma
        let histogramBins = [];
        let histogramCounts = [];
        
        // Elementos del DOM
        const totalElement = document.getElementById('total');
        const shapeParamElement = document.getElementById('shapeParam');
        const scaleParamElement = document.getElementById('scaleParam');
        const numBinsElement = document.getElementById('numBins');
        const maxValueElement = document.getElementById('maxValue');
        const currentKElement = document.getElementById('currentK');
        const currentThetaElement = document.getElementById('currentTheta');
        const speedControl = document.getElementById('speed');
        const speedValueElement = document.getElementById('speedValue');
        const resultsTableBody = document.querySelector('#resultsTable tbody');
        const frequencyCtx = document.getElementById('frequencyChart').getContext('2d');
        const theoreticalMeanElement = document.getElementById('theoreticalMean');
        const theoreticalVarianceElement = document.getElementById('theoreticalVariance');
        const meanValueElement = document.getElementById('meanValue');
        const varianceValueElement = document.getElementById('varianceValue');
        const histogramCtx = document.getElementById('histogramChart').getContext('2d');
        
        let frequencyChart;
        let meanChart;
        let histogramChart;

        // Función gamma aproximada (algoritmo de Lanczos)
        function gamma(z) {
            const g = 7;
            const p = [
                0.99999999999980993, 676.5203681218851, -1259.1392167224028,
                771.32342877765313, -176.61502916214059, 12.507343278686905,
                -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7
            ];

            if (z < 0.5) {
                // Handle negative integers, as gamma is undefined for them
                if (Number.isInteger(z) && z <= 0) {
                    console.warn("Gamma function is undefined for non-positive integers.");
                    return NaN; // Or throw an error, depending on desired behavior
                }
                return Math.PI / (Math.sin(Math.PI * z) * gamma(1 - z));
            } else {
                z -= 1;

                let x = p[0];
                for (let i = 1; i < g + 2; i++) {
                    x += p[i] / (z + i);
                }

                const t = z + g + 0.5;
                return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
            }
        }

        // Función de densidad de probabilidad Gamma
        function gammaPDF(x, k, theta) {
            if (x <= 0) return 0;
            return (Math.pow(x, k - 1) * Math.exp(-x / theta)) / (Math.pow(theta, k) * gamma(k));
        }

        // Generar variable aleatoria Gamma (algoritmo de Marsaglia y Tsang)
        function generateGamma(k, theta) {
            if (k < 1) {
                // Usar el método de transformación inversa para k < 1
                const u = Math.random();
                return theta * Math.pow(u, 1 / k) * generateGamma(1 + k, 1);
            }
            
            const d = k - 1 / 3;
            const c = 1 / Math.sqrt(9 * d);
            
            while (true) {
                let v = 0;
                let x = 0;
                
                do {
                    x = randomNormal();
                    v = 1 + c * x;
                } while (v <= 0);
                
                v = v * v * v;
                const u = Math.random();
                
                if (u < 1 - 0.0331 * x * x * x * x) {
                    return d * v * theta;
                }
                
                if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) {
                    return d * v * theta;
                }
            }
        }

        // Generar variable aleatoria Normal (para el método de Marsaglia)
        function randomNormal() {
            let u = 0, v = 0;
            while (u === 0) u = Math.random(); // Evitar log(0)
            while (v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        // Calcular la media teórica
        function calculateTheoreticalMean(k, theta) {
            return k * theta;
        }

        // Calcular la varianza teórica
        function calculateTheoreticalVariance(k, theta) {
            return k * theta * theta;
        }

        // Calcular la media de los resultados
        function calculateMean() {
            let sum = 0;
            let count = 0;
            
            for (let i = 0; i < histogramBins.length; i++) {
                const binCenter = (histogramBins[i].min + histogramBins[i].max) / 2;
                sum += binCenter * histogramCounts[i];
                count += histogramCounts[i];
            }
            
            return count > 0 ? sum / count : 0;
        }

        // Calcular la varianza de los resultados
        function calculateVariance(mean) {
            let sumSquaredDiff = 0;
            let count = 0;
            
            for (let i = 0; i < histogramBins.length; i++) {
                const binCenter = (histogramBins[i].min + histogramBins[i].max) / 2;
                const diff = binCenter - mean;
                sumSquaredDiff += diff * diff * histogramCounts[i];
                count += histogramCounts[i];
            }
            
            return count > 0 ? sumSquaredDiff / count : 0;
        }

        // Inicializar la distribución
        function initializeDistribution() {
            shapeParam = parseFloat(shapeParamElement.value);
            scaleParam = parseFloat(scaleParamElement.value);
            numBins = parseInt(numBinsElement.value);
            maxValue = parseFloat(maxValueElement.value);
            
            // Validar los valores
            if (shapeParam <= 0) shapeParam = 0.1;
            if (scaleParam <= 0) scaleParam = 0.1;
            if (numBins < 5) numBins = 5;
            if (numBins > 50) numBins = 50;
            if (maxValue <= 0) maxValue = 1;
            
            shapeParamElement.value = shapeParam.toFixed(1);
            scaleParamElement.value = scaleParam.toFixed(1);
            numBinsElement.value = numBins;
            maxValueElement.value = maxValue;
            
            // Actualizar la visualización de parámetros
            currentKElement.textContent = shapeParam.toFixed(1);
            currentThetaElement.textContent = scaleParam.toFixed(1);
            
            // Calcular propiedades teóricas
            const theoreticalMean = calculateTheoreticalMean(shapeParam, scaleParam);
            const theoreticalVariance = calculateTheoreticalVariance(shapeParam, scaleParam);
            
            theoreticalMeanElement.textContent = theoreticalMean.toFixed(4);
            theoreticalVarianceElement.textContent = theoreticalVariance.toFixed(4);
            
            // Inicializar histograma
            initializeHistogram();
            
            // Reiniciar resultados
            totalSimulations = 0;
            meanHistory = [];
            
            // Actualizar la tabla de resultados
            updateResultsTable();
            
            // Inicializar o actualizar los gráficos
            initializeCharts();
            
            // Actualizar la UI
            updateUI();
        }

        // Inicializar los bins del histograma
        function initializeHistogram() {
            histogramBins = [];
            histogramCounts = [];
            
            const binWidth = maxValue / numBins;
            
            for (let i = 0; i < numBins; i++) {
                histogramBins.push({
                    min: i * binWidth,
                    max: (i + 1) * binWidth
                });
                histogramCounts.push(0);
            }
            
            // Agregar un bin para valores mayores a maxValue
            histogramBins.push({
                min: maxValue,
                max: Infinity
            });
            histogramCounts.push(0);
        }

        // Inicializar los gráficos
        function initializeCharts() {
            const labels = [];
            const binWidth = maxValue / numBins;
            
            for (let i = 0; i < numBins; i++) {
                labels.push(`${(i * binWidth).toFixed(1)}-${((i + 1) * binWidth).toFixed(1)}`);
            }
            labels.push(`>${maxValue.toFixed(1)}`);
            
            // Gráfico de frecuencia
            if (frequencyChart) {
                frequencyChart.destroy();
            }
            
            frequencyChart = new Chart(frequencyCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Frecuencia observada',
                            data: new Array(labels.length).fill(0),
                            backgroundColor: colorPalette,
                            borderWidth: 1
                        },
                        {
                            label: 'Distribución teórica',
                            data: new Array(labels.length).fill(0),
                            type: 'line',
                            borderColor: '#333',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#333',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Intervalos de valores'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y;
                                    if (context.datasetIndex === 1) {
                                        label += ' (teórico)';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de media
            if (meanChart) {
                meanChart.destroy();
            }
            
            const meanCtx = document.getElementById('meanChart').getContext('2d');
            meanChart = new Chart(meanCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Media de la simulación',
                        data: [],
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: true,
                        tension: 0.1
                    }, {
                        label: 'Media teórica',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0)',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Valor de la media'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Número de simulaciones'
                            }
                        }
                    }
                }
            });
            
            // Gráfico de histograma
            if (histogramChart) {
                histogramChart.destroy();
            }
            
            histogramChart = new Chart(histogramCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: new Array(labels.length).fill(0),
                        backgroundColor: colorPalette,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Intervalos de valores'
                            }
                        }
                    }
                }
            });
            
            // Actualizar datos teóricos
            updateTheoreticalData();
        }

        // Actualizar datos teóricos en el gráfico
        function updateTheoreticalData() {
            if (!frequencyChart) return;
            
            const theoreticalData = [];
            const binWidth = maxValue / numBins;
            let totalTheoretical = 0;
            
            // Calcular probabilidad teórica para cada bin
            for (let i = 0; i < numBins; i++) {
                const min = i * binWidth;
                const max = (i + 1) * binWidth;
                
                // Integración numérica simple (regla del trapecio)
                let prob = 0;
                const steps = 10;
                const stepSize = (max - min) / steps;
                
                for (let j = 0; j < steps; j++) {
                    const x1 = min + j * stepSize;
                    const x2 = x1 + stepSize;
                    const y1 = gammaPDF(x1, shapeParam, scaleParam);
                    const y2 = gammaPDF(x2, shapeParam, scaleParam);
                    prob += (y1 + y2) * stepSize / 2;
                }
                
                theoreticalData.push(prob * totalSimulations);
                totalTheoretical += prob;
            }
            
            // Probabilidad para valores mayores a maxValue
            theoreticalData.push((1 - totalTheoretical) * totalSimulations);
            
            frequencyChart.data.datasets[1].data = theoreticalData;
            frequencyChart.update();
        }

        // Actualizar la tabla de resultados
        function updateResultsTable() {
            resultsTableBody.innerHTML = '';
            
            let totalFreq = 0;
            let totalTheoretical = 0;
            const binWidth = maxValue / numBins;
            
            for (let i = 0; i < numBins; i++) {
                const row = document.createElement('tr');
                
                // Intervalo
                const intervalCell = document.createElement('td');
                intervalCell.textContent = `${(i * binWidth).toFixed(2)}-${((i + 1) * binWidth).toFixed(2)}`;
                
                // Frecuencia observada
                const freqCell = document.createElement('td');
                const freq = histogramCounts[i] || 0;
                freqCell.textContent = freq;
                freqCell.id = `freq-${i}`;
                
                // Frecuencia relativa
                const relFreqCell = document.createElement('td');
                const relFreq = totalSimulations > 0 ? (freq / totalSimulations).toFixed(4) : '0';
                relFreqCell.textContent = relFreq;
                relFreqCell.id = `rel-freq-${i}`;
                
                // Probabilidad teórica
                const min = i * binWidth;
                const max = (i + 1) * binWidth;
                
                // Integración numérica simple (regla del trapecio)
                let prob = 0;
                const steps = 10;
                const stepSize = (max - min) / steps;
                
                for (let j = 0; j < steps; j++) {
                    const x1 = min + j * stepSize;
                    const x2 = x1 + stepSize;
                    const y1 = gammaPDF(x1, shapeParam, scaleParam);
                    const y2 = gammaPDF(x2, shapeParam, scaleParam);
                    prob += (y1 + y2) * stepSize / 2;
                }
                
                const theoreticalCell = document.createElement('td');
                theoreticalCell.textContent = prob.toFixed(4);
                theoreticalCell.id = `theoretical-${i}`;
                
                // Diferencia
                const diffCell = document.createElement('td');
                const diff = totalSimulations > 0 ? Math.abs(relFreq - prob).toFixed(4) : '0';
                diffCell.textContent = diff;
                diffCell.style.backgroundColor = `rgba(255, 0, 0, ${diff * 5})`;
                diffCell.id = `diff-${i}`;
                
                row.appendChild(intervalCell);
                row.appendChild(freqCell);
                row.appendChild(relFreqCell);
                row.appendChild(theoreticalCell);
                row.appendChild(diffCell);
                
                resultsTableBody.appendChild(row);
                totalFreq += freq;
                totalTheoretical += prob;
            }
            
            // Fila para valores mayores a maxValue
            const extraRow = document.createElement('tr');
            
            const extraIntervalCell = document.createElement('td');
            extraIntervalCell.textContent = `>${maxValue.toFixed(2)}`;
            
            const extraFreqCell = document.createElement('td');
            const extraFreq = histogramCounts[numBins] || 0;
            extraFreqCell.textContent = extraFreq;
            extraFreqCell.id = 'freq-extra';
            
            const extraRelFreqCell = document.createElement('td');
            const extraRelFreq = totalSimulations > 0 ? (extraFreq / totalSimulations).toFixed(4) : '0';
            extraRelFreqCell.textContent = extraRelFreq;
            extraRelFreqCell.id = 'rel-freq-extra';
            
            const extraTheoreticalCell = document.createElement('td');
            const extraTheoreticalProb = 1 - totalTheoretical;
            extraTheoreticalCell.textContent = extraTheoreticalProb.toFixed(4);
            extraTheoreticalCell.id = 'theoretical-extra';
            
            const extraDiffCell = document.createElement('td');
            const extraDiff = totalSimulations > 0 ? Math.abs(extraRelFreq - extraTheoreticalProb).toFixed(4) : '0';
            extraDiffCell.textContent = extraDiff;
            extraDiffCell.style.backgroundColor = `rgba(255, 0, 0, ${extraDiff * 5})`;
            extraDiffCell.id = 'diff-extra';
            
            extraRow.appendChild(extraIntervalCell);
            extraRow.appendChild(extraFreqCell);
            extraRow.appendChild(extraRelFreqCell);
            extraRow.appendChild(extraTheoreticalCell);
            extraRow.appendChild(extraDiffCell);
            
            resultsTableBody.appendChild(extraRow);
            totalFreq += extraFreq;
            totalTheoretical += extraTheoreticalProb;
            
            // Fila de totales
            const totalRow = document.createElement('tr');
            totalRow.className = 'sum-row';
            
            const totalLabelCell = document.createElement('td');
            totalLabelCell.textContent = 'Total';
            
            const totalFreqCell = document.createElement('td');
            totalFreqCell.textContent = totalFreq;
            totalFreqCell.id = 'totalFreq';
            
            const totalRelFreqCell = document.createElement('td');
            totalRelFreqCell.textContent = '1.0000';
            
            const totalTheoreticalCell = document.createElement('td');
            totalTheoreticalCell.textContent = '1.0000';
            
            const totalDiffCell = document.createElement('td');
            totalDiffCell.textContent = '';
            
            totalRow.appendChild(totalLabelCell);
            totalRow.appendChild(totalFreqCell);
            totalRow.appendChild(totalRelFreqCell);
            totalRow.appendChild(totalTheoreticalCell);
            totalRow.appendChild(totalDiffCell);
            
            resultsTableBody.appendChild(totalRow);
        }

        // Simular un valor Gamma
        function simulate() {
            const value = generateGamma(shapeParam, scaleParam);
            
            // Encontrar el bin correspondiente
            let binIndex = numBins; // Por defecto, el último bin (para valores > maxValue)
            
            for (let i = 0; i < numBins; i++) {
                if (value >= histogramBins[i].min && value < histogramBins[i].max) {
                    binIndex = i;
                    break;
                }
            }
            
            // Registrar el resultado
            histogramCounts[binIndex]++;
            totalSimulations++;
            
            return value;
        }

        // Actualizar la UI
        function updateUI() {
            totalElement.textContent = totalSimulations;
            
            // Actualizar datos del gráfico de frecuencia
            frequencyChart.data.datasets[0].data = histogramCounts;
            
            // Actualizar datos teóricos
            updateTheoreticalData();
            
            // Calcular y mostrar media y varianza
            const mean = calculateMean();
            const variance = calculateVariance(mean);
            const theoreticalMean = calculateTheoreticalMean(shapeParam, scaleParam);
            
            meanValueElement.textContent = mean.toFixed(4);
            varianceValueElement.textContent = variance.toFixed(4);
            
            // Actualizar gráfico de media
            meanHistory.push(mean);
            
            meanChart.data.labels = Array.from({length: meanHistory.length}, (_, i) => i + 1);
            meanChart.data.datasets[0].data = meanHistory;
            meanChart.data.datasets[1].data = Array(meanHistory.length).fill(theoreticalMean);
            meanChart.update();
            
            // Actualizar tabla de resultados
            let totalFreq = 0;
            let totalTheoretical = 0;
            const binWidth = maxValue / numBins;
            
            for (let i = 0; i < numBins; i++) {
                const freq = histogramCounts[i] || 0;
                totalFreq += freq;
                
                document.getElementById(`freq-${i}`).textContent = freq;
                
                const relFreq = totalSimulations > 0 ? (freq / totalSimulations).toFixed(4) : '0';
                document.getElementById(`rel-freq-${i}`).textContent = relFreq;
                
                // Calcular probabilidad teórica para el intervalo
                const min = i * binWidth;
                const max = (i + 1) * binWidth;
                
                let prob = 0;
                const steps = 10;
                const stepSize = (max - min) / steps;
                
                for (let j = 0; j < steps; j++) {
                    const x1 = min + j * stepSize;
                    const x2 = x1 + stepSize;
                    const y1 = gammaPDF(x1, shapeParam, scaleParam);
                    const y2 = gammaPDF(x2, shapeParam, scaleParam);
                    prob += (y1 + y2) * stepSize / 2;
                }
                
                totalTheoretical += prob;
                document.getElementById(`theoretical-${i}`).textContent = prob.toFixed(4);
                
                const diff = Math.abs(relFreq - prob).toFixed(4);
                document.getElementById(`diff-${i}`).textContent = diff;
                document.getElementById(`diff-${i}`).style.backgroundColor = `rgba(255, 0, 0, ${diff * 5})`;
            }
            
            // Actualizar fila de "más de maxValue"
            const extraFreq = histogramCounts[numBins] || 0;
            totalFreq += extraFreq;
            
            document.getElementById('freq-extra').textContent = extraFreq;
            
            const extraRelFreq = totalSimulations > 0 ? (extraFreq / totalSimulations).toFixed(4) : '0';
            document.getElementById('rel-freq-extra').textContent = extraRelFreq;
            
            const extraTheoreticalProb = 1 - totalTheoretical;
            document.getElementById('theoretical-extra').textContent = extraTheoreticalProb.toFixed(4);
            
            const extraDiff = Math.abs(extraRelFreq - extraTheoreticalProb).toFixed(4);
            document.getElementById('diff-extra').textContent = extraDiff;
            document.getElementById('diff-extra').style.backgroundColor = `rgba(255, 0, 0, ${extraDiff * 5})`;
            
            document.getElementById('totalFreq').textContent = totalFreq;
            
            // Actualizar histograma
            histogramChart.data.datasets[0].data = histogramCounts;
            histogramChart.update();
        }

        // Simular múltiples ensayos
        function simulateMultiple(times, delay = 0) {
            if (animationId) {
                cancelAnimationFrame(animationId);
                clearTimeout(animationId);
                animationId = null;
            }

            let count = 0;
            let delayTime = (11 - simulationSpeed) * 20;

            function runSimulation() {
                if (count < times) {
                    simulate();
                    updateUI();
                    count++;

                    if (delay > 0) {
                        animationId = setTimeout(runSimulation, delayTime);
                    } else {
                        animationId = requestAnimationFrame(runSimulation);
                    }
                } else {
                    animationId = null;
                }
            }

            runSimulation();
        }

        // Event listeners
        document.getElementById('simulate1').addEventListener('click', () => {
            simulate();
            updateUI();
        });

        document.getElementById('simulate10').addEventListener('click', () => {
            simulateMultiple(10, 100);
        });

        document.getElementById('simulate100').addEventListener('click', () => {
            simulateMultiple(100, 10);
        });

        document.getElementById('simulate1000').addEventListener('click', () => {
            simulateMultiple(1000);
        });

        document.getElementById('reset').addEventListener('click', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
                clearTimeout(animationId);
                animationId = null;
            }
            initializeDistribution();
        });

        speedControl.addEventListener('input', () => {
            simulationSpeed = parseInt(speedControl.value);
            speedValueElement.textContent = simulationSpeed;
        });

        shapeParamElement.addEventListener('change', () => {
            initializeDistribution();
        });

        scaleParamElement.addEventListener('change', () => {
            initializeDistribution();
        });

        numBinsElement.addEventListener('change', () => {
            initializeDistribution();
        });

        maxValueElement.addEventListener('change', () => {
            initializeDistribution();
        });

        // Inicializar al cargar la página
        initializeDistribution();
    </script>
</body>
</html>